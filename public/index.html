<!DOCTYPE html>
	<html>
	<head>
		<title>Game</title>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="shortcut icon" href="#">
		<style>
			canvas {
				background-color: grey;
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas" height="640" width="960" ></canvas>
		<script type="text/javascript">
			var socket = io('http://localhost:3000')

			const canvas = document.getElementById('canvas')
			const ctx = canvas.getContext('2d')
			canvas.addEventListener('click', getMousePos, false);

			/*
				VARIABLES
			*/

			const HEIGHT = 640
			const WIDTH = 960

			const KEYS = {
				up: 87,
				down: 83,
				right: 68,
				left: 65,
				shootRight: 39,
				shootLeft: 37
			}

			let keyUp = false;
			let keyDown = false;
			let keyRight = false;
			let keyLeft = false;
			let shootRight = false;
			let shootLeft = false;
			let jumpTime = 0;
			let terrain = [];

			function createMap(){
				terrain.push({x: 0, 					y: 0, 				w: 1, 			h: HEIGHT	});
				terrain.push({x: 0, 					y: HEIGHT - 2, 		w: WIDTH, 		h: 50		});
				terrain.push({x: WIDTH - 1, 			y: 0, 				w: 1, 			h: HEIGHT	});
				terrain.push({x: 0, 					y: HEIGHT - 96, 	w: WIDTH / 2.5, h: 32		});
				terrain.push({x: WIDTH - (WIDTH / 2.5), y: HEIGHT - 96, 	w: WIDTH / 2.5, h: 32		});
				terrain.push({x: 0, 					y: HEIGHT - 192, 	w: 96, 			h: 32		});
				terrain.push({x: WIDTH - 96, 			y: HEIGHT - 192, 	w: 96, 			h: 32		});
				terrain.push({x: 192, 					y: HEIGHT - 288, 	w: 96, 			h: 32		});
				terrain.push({x: WIDTH - 192 - 96, 		y: HEIGHT - 288, 	w: 96, 			h: 32		});
				terrain.push({x: 0, 					y: HEIGHT - 384, 	w: 96, 			h: 32		});
				terrain.push({x: WIDTH / 2 - 37, 		y: HEIGHT - 384, 	w: 96, 			h: 32		});
				terrain.push({x: WIDTH - 96, 			y: HEIGHT - 384, 	w: 96, 			h: 32		});
				terrain.push({x: WIDTH - 96 - 192, 		y: HEIGHT - 480, 	w: 96, 			h: 32		});
				terrain.push({x: 192, 					y: HEIGHT - 480, 	w: 96, 			h: 32		});
			}

			let player = {
				name: 'player',
				//x: Math.floor(Math.random() * WIDTH),
				//y: Math.floor(Math.random() * HEIGHT),
				x: 40,
				y: 40,
				speed: 2,
				w: 32,
				h: 32,
				gravity: 4,
				hp: 100,
			}

			let bulletPlayer = {
				name: player.name,
				x: player.x + (player.w / 2),
				y: player.y + (player.h / 2),
				w: 4,
				h: 4,
				speed: 2,
				shooting: false,
				hp: 100,
				jumping: false,
			}

			let enemy = {}

			let bulletEnemy = {
				name: enemy.name,
				x: enemy.x + (player.w / 2),
				y: enemy.y + (player.h / 2),
				w: 4,
				h: 4,
				speed: 2,
				shooting: false,
			}

			/*
				FUNCTIONS
			*/

			document.addEventListener('keydown', getKey, false);
			let input = ''

			function getKey(e) {
				var keycode = parseInt(e.which);
				if (keycode == 46 || keycode == 8) {
					e.preventDefault(); //prevent back navigation from backspace
					input = input.slice(0,input.length-1);
					console.log(input)
				}else {
					if(e.keyCode >= 65 && e.keyCode <= 90){
						var keycode = parseInt(e.which);
						if (input.length < 10){
							input += String.fromCharCode(keycode);
						}
					}else{
						if(e.keyCode === 13){
							if(input.length !== 0){
								///////////////ADICIONAR A VERIFICAÇÃO DO NOME////////////////////////////////////
								player.name = input;
								createMap();
								game();
							}else{
								alert('Digite seu nome');
							}
						}
					}
				}
				drawName()
			}

			function getMousePos(e) {
				var rect = canvas.getBoundingClientRect();		
				var x = e.clientX - rect.left;
				var y = e.clientY - rect.top;
				if(x > WIDTH / 2 - 80 && x < WIDTH / 2 + 120 &&
				   y > HEIGHT / 2 + 50 && y < HEIGHT / 2 + 100){
					if(input.length !== 0){
						///////////////ADICIONAR A VERIFICAÇÃO DO NOME////////////////////////////////////
						player.name = input;
						createMap();
						game();
					}else{
						alert('Digite seu nome')
					}
				}
			}
			
			window.onload = function(){
				drawName()
			}

			function drawName(){
				ctx.fillStyle = "white"
				ctx.fillRect(0, 0, WIDTH, HEIGHT)
				ctx.font = "20px Georgia";
				ctx.fillStyle = "black"
				ctx.fillText("Digite seu nome:", WIDTH / 2 - 60, HEIGHT / 2 - 10);
				ctx.fillStyle = "blue"
				ctx.fillRect(WIDTH / 2 - 80, HEIGHT / 2 + 50, 200, 50)
				ctx.font = "20px Georgia";
				ctx.fillStyle = "white"
				ctx.fillText("Começar Jogo", WIDTH / 2 - 40, HEIGHT / 2 + 80);
				if(input.length === 0){
					ctx.font = "20px Georgia";
					ctx.fillStyle = "black"
					ctx.fillText('|', WIDTH / 2 - 60, HEIGHT / 2 + 10);	
				}else{
					ctx.font = "20px Georgia";
					ctx.fillStyle = "black"
					ctx.fillText(input, WIDTH / 2 - 60, HEIGHT / 2 + 10);
				}
			}

			function game(){
				document.addEventListener('keydown', keyDownHandler, false);
				document.addEventListener('keyup', keyUpHandler, false);
				document.removeEventListener('keydown', getKey, false);
				document.removeEventListener('click', getMousePos, false);

				/*
					DRAW
				*/
				function draw(){
					ctx.fillStyle = "white"
					ctx.fillRect(0, 0, WIDTH, HEIGHT)
					ctx.fillStyle = 'blue'
					ctx.fillRect(player.x, player.y, player.w, player.h);
					ctx.font = "20px Georgia";
					ctx.fillStyle = "black"
					ctx.fillText(player.name, 20, 40);
					ctx.fillText(player.hp, 20, 80);
					if(enemy !== {}){
						ctx.fillStyle = "black"
						ctx.fillText(enemy.name, WIDTH - 80, 40);
						ctx.fillText(enemy.hp, WIDTH - 80, 80);
						ctx.fillStyle = 'red'
						ctx.fillRect(enemy.x, enemy.y, enemy.w, enemy.h);
					}
					if(bulletPlayer.shooting){
						ctx.fillStyle = 'black'
						ctx.fillRect(bulletPlayer.x, bulletPlayer.y, bulletPlayer.w, bulletPlayer.h);
					}
					if(bulletEnemy.shooting){
						ctx.fillStyle = 'black'
						ctx.fillRect(bulletEnemy.x, bulletEnemy.y, bulletEnemy.w, bulletEnemy.h);
					}
					terrain.forEach(value => {
						ctx.fillStyle = 'black'
						ctx.fillRect(value.x, value.y, value.w, value.h);
					})
				}

				/*
					DRAW
				*/

				function update(){
					for (var i = 0; i < terrain.length; i++) {
				    	
				        ctx.rect(terrain[i].x, terrain[i].y, terrain[i].w, terrain[i].h);
				        
				        
				        var dir = colCheck(player, terrain[i]);
				        if (dir === "l" || dir === "r") {
							console.log('here')
				            //player.gravity = 0;
							//jumpTime = 0;
							//player.y = terrain[i].y - player.h
				        } else if (dir === "t") {
				            //player.gravity = 0;
							jumpTime = 30;
							player.y = terrain[i].y + terrain[i].h
							keyUp = false;
				        } else if (dir === "b") {
							console.log('em cima')
				            //player.gravity = 0;
							jumpTime = 0;
							player.y = terrain[i].y - player.h
				        }
					}

					player.y += player.gravity
					if(player.jumping){
						player.speed = 3;
					}else{
						player.speed = 2;
					}
					if(jumpTime > 18){
						keyUp = false;
						player.jumping = false;
					}
					if(player.y + player.h >= HEIGHT){
						//player.gravity = 0;
						jumpTime = 0;
					}
					if(player.y + player.h < HEIGHT && !keyUp){
						player.gravity = 5;
					}
					if(player.y + player.h > HEIGHT){
						player.y = HEIGHT - player.h
					}
					if(keyRight) {
						if(player.x + player.w <= WIDTH){
							player.x += player.speed
						}else{
							keyRight = false;
						}
					}
					if(keyLeft){
						if(player.x >= 0){
							player.x -= player.speed
						}else{
							keyLeft = false;
						}
					}
					if(keyUp){
						jumpTime++;
						player.gravity = -8;
					}
					if(keyDown){
						console.log('Abaixar')
						if(player.y + player.h <= HEIGHT){
							player.h = 16;
							player.y = player.y + (player.h / 2)
						}
					}
					if(shootLeft){
						bulletPlayer.shooting = true;
						bulletPlayer.x = player.x + (player.w / 2)
						bulletPlayer.y = player.y + (player.h / 2)
						bulletPlayer.speed = -8;
					}
					if(shootRight){
						bulletPlayer.shooting = true;
						bulletPlayer.x = player.x + (player.w / 2)
						bulletPlayer.y = player.y + (player.h / 2)
						bulletPlayer.speed = 8;
					}
					if(bulletPlayer.shooting){
						bulletPlayer.x += bulletPlayer.speed
						socket.emit('shot', bulletPlayer);
					}
					/*
					if(bulletPlayer.x + bulletPlayer.w > enemy.x && 
						bulletPlayer.x < enemy.x + enemy.w &&
						bulletPlayer.y + bulletPlayer.h > enemy.y &&
						bulletPlayer.y < enemy.y + enemy.h){
						console.log('acertou')
						bulletPlayer.shooting = false;
					}
					*/
					if(bulletPlayer.x > WIDTH || bulletPlayer.x < 0){
						bulletPlayer.shooting = false;
					}
				}

				function createbulletPlayer(direction){
					bulletPlayer.speed = direction
				}

				/*
					KEYBOAR HANDLER
				*/
				function keyDownHandler(event) {
					if(event.keyCode == KEYS.right) {
						keyRight = true;
					}
					if(event.keyCode == KEYS.left){
						if(player.x > 0){
							keyLeft = true;
						}					
					}
					if(event.keyCode == KEYS.up){
						if(player.y > 0){
							keyUp = true;
							player.jumping = true;
						}					
					}
					if(event.keyCode == KEYS.down){
						keyDown = true;
					}
					if(!bulletPlayer.shooting){
						if(event.keyCode === KEYS.shootLeft){
							shootLeft = true;
						}
						if(event.keyCode === KEYS.shootRight){
							shootRight = true;
						}
					}
				}

				function keyUpHandler(event) {
					if(event.keyCode == KEYS.right) {
						keyRight = false;
					}
					if(event.keyCode == KEYS.left){
						keyLeft = false;
					}
					if(event.keyCode == KEYS.up){
						//keyUp = false;
					}
					if(event.keyCode == KEYS.down){
						player.y = player.y - (player.h / 2)
						player.h = 32;
						keyDown = false;
					}
					if(event.keyCode == KEYS.shootLeft){
						shootLeft = false;
					}
					if(event.keyCode == KEYS.shootRight){
						shootRight = false;
					}
				}

				function colCheck(shapeA, shapeB) {
				    
				    var vX = (shapeA.x + (shapeA.w / 2)) - (shapeB.x + (shapeB.w / 2)),
				        vY = (shapeA.y + (shapeA.h / 2)) - (shapeB.y + (shapeB.h / 2)),
				        
				        hWidths = (shapeA.w / 2) + (shapeB.w / 2),
				        hHeights = (shapeA.h / 2) + (shapeB.h / 2),
				        colDir = null;
				    
				    if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
				        
				        var oX = hWidths - Math.abs(vX),
				            oY = hHeights - Math.abs(vY);
				        if (oX >= oY) {
				            if (vY > 0) {
				                colDir = "t";
				                shapeA.y += oY;
				            } else {
				                colDir = "b";
				                shapeA.y -= oY;
				            }
				        } else {
				            if (vX > 0) {
				                colDir = "l";
				                shapeA.x += oX;
				            } else {
				                colDir = "r";
				                shapeA.x -= oX;
				            }
				        }
				    }
				    return colDir;
				}

				socket.on('position', data => {
					if(data.name === player.name){
						player = data
					}else{
						enemy = data
					}
				})

				socket.on('bullets', data => {
					if(data.name === player.name){
						bulletPlayer = data;
					}else{
						bulletEnemy = data;
					}
				})

				setInterval(function() {
					socket.emit('sendPosition', player);
					update()
					draw()
				}, 1000/60)
			}
		</script>
	</body>
</html>