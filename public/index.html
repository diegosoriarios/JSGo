<!DOCTYPE html>
	<html>
	<head>
		<title>Game</title>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="shortcut icon" href="#">
		<style>
			canvas {
				background-color: grey;
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<canvas id="canvas" height="600" width="800"></canvas>
		<script type="text/javascript">
			var socket = io('http://localhost:3000')
			/*
				VARIABLES
			*/
			canvas = document.getElementById("canvas");
		    ctx = canvas.getContext("2d");
		    canvas.addEventListener('click', getMousePos, false);
			var canvas,
			ctx,
			width,
			status,
			height,
			player,
			princess,
			keys,
			terrain,
			bumpers,
			evil,
			bullet,
			evilBullet,
			friction,
			gravity,
			enemy,
			enemy2,
			enemy3,
			sniper,
			hellfire;
			width = 800;
			status = 'playing';
			height = 600;
			player = {
				color: '#B9DAFB',
				x: 0,
				y: height/2,
				width: 30,
				height: 30,
				speed: 6,
				velX: 0,
				velY: 0,
				jumping: false,
				grounded: false,
				facing: 'right',
				shot: false,
				name: '',
				hp: 100
			};
			princess = {
				color: '#F5ABC7',
				width: 30,
				height: 30,
				x: width - 31,
				y: 50
			};
			keys = [];
			terrain = [];
			evil = [];
			bullet = {
				color: '#FDDD32',
				width: 10,
				height: 10,
				x: -10,
				y: -10,
				speed: 8,
				direction: null
			};
			evilBullet = {
				x: -10,
				y: -10,
				width: 10,
				height: 10,
				speed: 8,
				mortal: false	
			};
			friction = 0.8;
			gravity = 0.8;
			enemy = {};
			hellfire = {
				x: 0,
				y: height - 40,
				width: width,
				height: 40,
				mortal: false
			};

			/*enemies into evil for collision
			evil.push(enemy);
			evil.push(hellfire);
			evil.push(enemy2);
			evil.push(enemy3);
			evil.push(sniper);
			evil.push(evilBullet);

			*/
			
			evil.push(hellfire);
	
			terrain.push({x: 0, 					y: 0, 				width: 1, 			height: height	});
			terrain.push({x: 0, 					y: height - 2, 		width: width, 		height: 50		});
			terrain.push({x: width - 1, 			y: 0, 				width: 1, 			height: height	});
			terrain.push({x: 0, 					y: height - 96, 	width: width / 2.5, height: 32		});
			terrain.push({x: width - (width / 2.5), y: height - 96, 	width: width / 2.5, height: 32		});
			terrain.push({x: 0, 					y: height - 192, 	width: 96, 			height: 32		});
			terrain.push({x: width - 96, 			y: height - 192, 	width: 96, 			height: 32		});
			terrain.push({x: 192, 					y: height - 288, 	width: 96, 			height: 32		});
			terrain.push({x: width - 192 - 96, 		y: height - 288, 	width: 96, 			height: 32		});
			terrain.push({x: 0, 					y: height - 384, 	width: 96, 			height: 32		});
			terrain.push({x: width / 2 - 37, 		y: height - 384, 	width: 96, 			height: 32		});
			terrain.push({x: width - 96, 			y: height - 384, 	width: 96, 			height: 32		});
			terrain.push({x: width - 96 - 192, 		y: height - 480, 	width: 96, 			height: 32		});
			terrain.push({x: 192, 					y: height - 480, 	width: 96, 			height: 32		});

			canvas.width = width;
			canvas.height = height;


			/*
				FUNCTIONS
			*/
			document.addEventListener('keydown', getKey, false);
			let input = ''
			function getKey(e) {
				var keycode = parseInt(e.which);
				if (keycode == 46 || keycode == 8) {
					e.preventDefault(); 
					input = input.slice(0,input.length-1);
					console.log(input)
				}else {
					if(e.keyCode >= 65 && e.keyCode <= 90){
						var keycode = parseInt(e.which);
						if (input.length < 10){
							input += String.fromCharCode(keycode);
						}
					}else{
						if(e.keyCode === 13){
							if(input.length !== 0){
								
								player.name = input;
								game();
							}else{
								alert('Digite seu nome');
							}
						}
					}
				}
				drawName()
			}
			function getMousePos(e) {
				var rect = canvas.getBoundingClientRect();		
				var x = e.clientX - rect.left;
				var y = e.clientY - rect.top;
				if(x > width / 2 - 80 && x < width / 2 + 120 &&
				   y > height / 2 + 50 && y < height / 2 + 100){
					if(input.length !== 0){
						
						player.name = input;
						game();
					}else{
						alert('Digite seu nome')
					}
				}
			}
			
			window.onload = function(){
				drawName()
			}
			function drawName(){
				ctx.fillStyle = "white"
				ctx.fillRect(0, 0, width, height)
				ctx.font = "20px Georgia";
				ctx.fillStyle = "black"
				ctx.fillText("Digite seu nome:", width / 2 - 60, height / 2 - 10);
				ctx.fillStyle = "blue"
				ctx.fillRect(width / 2 - 80, height / 2 + 50, 200, 50)
				ctx.font = "20px Georgia";
				ctx.fillStyle = "white"
				ctx.fillText("ComeÃ§ar Jogo", width / 2 - 40, height / 2 + 80);
				if(input.length === 0){
					ctx.font = "20px Georgia";
					ctx.fillStyle = "black"
					ctx.fillText('|', width / 2 - 60, height / 2 + 10);	
				}else{
					ctx.font = "20px Georgia";
					ctx.fillStyle = "black"
					ctx.fillText(input, width / 2 - 60, height / 2 + 10);
				}


			}

			
			function game(){
				var gameStarted = false;

				
				(function() {
				    var requestAnimationFrame = window.requestAnimationFrame || window.mozRequestAnimationFrame || window.webkitRequestAnimationFrame || window.msRequestAnimationFrame;
				    window.requestAnimationFrame = requestAnimationFrame;
				})();

				
				

				
				function reset(){

				    

				}

				reset();

				
				function update() {
					socket.emit('sendPosition', player)
				    
				    if (keys[38] || keys[87]) {
				        
				        if (!player.jumping && player.grounded) {
				            player.jumping = true;
				            player.grounded = false;
				            player.velY = -player.speed * 2.5;
				        }
				    }
				    if (keys[39] || keys[68]) {
				        
				        player.facing = "right";
				        if (player.velX < player.speed) {
				            player.velX++;
				        }
				    }
				    if (keys[37] || keys[65]) {
				        
				        if (player.velX > -player.speed) {
				            player.velX--;
				        }
				        player.facing = "left";
				    }
				    if (keys[32]){
				    	
				    	if(status === 'win'){
				    		reset();
				    	}else if(player.shot === false){
				    		player.shot = true;
				    		bullet.direction = player.facing;
				    		bullet.x = player.x + 30;
				    		bullet.y = player.y + 10;
				    	}

				    }

				    
				    player.velX *= friction;
				    player.velY += gravity;

				    
				    ctx.clearRect(0, 0, width, height);
				    ctx.fillStyle = "black";
				    ctx.beginPath();

				    
				    player.grounded = false;
				    for (var i = 0; i < terrain.length; i++) {
				    	
				        ctx.rect(terrain[i].x, terrain[i].y, terrain[i].width, terrain[i].height);
				        
				        
				        var dir = colCheck(player, terrain[i]);

				        if (dir === "l" || dir === "r") {
				            player.velX = 0;
				            player.jumping = false;
				        } else if (dir === "t") {
				            player.velY *= -1;
				        } else if (dir === "b") {
				            player.grounded = true;
				            player.jumping = false;
				        }

				        
				        var dth = colCheck(bullet, terrain[i]);

				        if (dth != null) {
				            player.shot = false;
				        }

				        
				        var dte = colCheck(evilBullet, terrain[i]);

				        if (dte != null){
				        	sniper.shot = false;
				        }


				        
				        var dbz = colCheck(enemy, terrain[i]);

				        if (dbz === "l" || dbz === "r") {

				        } else if (dbz === "t") {
				            enemy.direction = 'down';
				        } else if (dbz === "b") {
				            enemy.direction = 'up';
				        }

				    }

				    
			        var love = colCheck(player, princess);

			        
			        if (love != null) {
			        	status = 'win';
			        }

				    

				    
				    for (var i = 0; i < evil.length; i++) {
				        
				        var dir = colCheck(player, evil[i]);

				        if (dir != null) {
				            resetPlayer();
				        }

				        
				        if(evil[i].mortal){
				        	var dth = colCheck(bullet, evil[i]);
					        if (dth === "l" || dth === "r") {
					            evil[i].alive = false;
					            player.shot = false;
					        } else if (dth === "t") {
					            evil[i].alive = false;
					            player.shot = false;
					        } else if (dth === "b") {
					            evil[i].alive = false;
					            player.shot = false;
					        }

					        
				        	if(!evil[i].alive){
					        	evil[i].x = -500;
					        	evil[i].y = -500;
				        	}
				        }

				    }

				    
				    
				    if(player.grounded){
				         player.velY = 0;
				    }
				    
				    player.x += player.velX;
				    player.y += player.velY;

				    if(player.shot){
				    	if(bullet.direction === 'right'){
				    		bullet.x += bullet.speed;
				    	}else if(bullet.direction === 'left'){
				    		bullet.x -= bullet.speed;
				    	}
				    }

				    ctx.fill();

				    
				    if(player.shot){
				    	ctx.fillStyle = bullet.color;
				    	ctx.fillRect(bullet.x, bullet.y, bullet.width, bullet.height);
				    }

				    
				    if(enemy.length > 0){
						ctx.fillStyle = "black"
						ctx.fillText(enemy.name, width - 80, 40);
						ctx.fillText(enemy.hp, width - 80, 80);
						ctx.fillStyle = 'red'
						ctx.fillRect(enemy.x, enemy.y, enemy.width, enemy.height);
					}
					evil.forEach(value => {
						ctx.fillStyle = 'red'
						ctx.fillRect(value.x, value.y, value.width, value.height);
					})

				    
				    ctx.fillStyle = player.color;
				    ctx.fillRect(player.x, player.y, player.width, player.height);
					ctx.font = "20px Georgia";
					ctx.fillStyle = "black"
					ctx.fillText(player.name, 20, 40);
					ctx.fillText(player.hp, 20, 80);

				    requestAnimationFrame(update);
				}

				
				function resetPlayer(){
					player.x = 0;
					player.y = height/2;
				}

				
				function colCheck(shapeA, shapeB) {
				    
				    var vX = (shapeA.x + (shapeA.width / 2)) - (shapeB.x + (shapeB.width / 2)),
				        vY = (shapeA.y + (shapeA.height / 2)) - (shapeB.y + (shapeB.height / 2)),
				        
				        hWidths = (shapeA.width / 2) + (shapeB.width / 2),
				        hHeights = (shapeA.height / 2) + (shapeB.height / 2),
				        colDir = null;

				    
				    if (Math.abs(vX) < hWidths && Math.abs(vY) < hHeights) {
				        
				        var oX = hWidths - Math.abs(vX),
				            oY = hHeights - Math.abs(vY);
				        if (oX >= oY) {
				            if (vY > 0) {
				                colDir = "t";
				                shapeA.y += oY;
				            } else {
				                colDir = "b";
				                shapeA.y -= oY;
				            }
				        } else {
				            if (vX > 0) {
				                colDir = "l";
				                shapeA.x += oX;
				            } else {
				                colDir = "r";
				                shapeA.x -= oX;
				            }
				        }
				    }
				    return colDir;
				}

				
				document.body.addEventListener("keydown", function (e) {
				    keys[e.keyCode] = true;
				});

				document.body.addEventListener("keyup", function (e) {
				    keys[e.keyCode] = false;
				});

			update();
			socket.on('position', data => {
				if(data.name === player.name){
					player = data
				}else{
					console.log(data)
					enemy = data
				}
			})
			}

		</script>
	</body>
</html>