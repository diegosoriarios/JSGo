<!DOCTYPE html>
	<html>
	<head>
		<title>Game</title>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="shortcut icon" href="#">
		<style>
			canvas {
				background-color: grey;
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<div id="form">
			<label>Nome: </label>
			<input name="nome" id="nome" />
			<button id="submit" onclick="salvarNome()">Salvar</button>
		</div>
		<canvas id="canvas" height="600" width="800" style="display: none"></canvas>
		<script type="text/javascript">
			var socket = io('http://localhost:3000')

			const canvas = document.getElementById('canvas')
			const ctx = canvas.getContext('2d')
			//canvas.addEventListener('click', getMousePos, false);
			document.addEventListener('keydown', keyDownHandler, false);
			document.addEventListener('keyup', keyUpHandler, false);

			/*
				VARIABLES
			*/

			const HEIGHT = 600
			const WIDTH = 800

			const KEYS = {
				up: 87,
				down: 83,
				right: 68,
				left: 65,
				shootRight: 39,
				shootLeft: 37
			}

			let keyUp = false;
			let keyDown = false;
			let keyRight = false;
			let keyLeft = false;
			let shootRight = false;
			let shootLeft = false;

			let player = {
				name: '',
				//x: Math.floor(Math.random() * WIDTH),
				//y: Math.floor(Math.random() * HEIGHT),
				x: 40,
				y: 40,
				speed: 2,
				w: 32,
				h: 32,
				gravity: 4,
			}

			let bulletPlayer = {
				x: player.x + (player.w / 2),
				y: player.y + (player.h / 2),
				w: 4,
				h: 4,
				speed: 2,
				shooting: false,
			}

			let enemy = {}

			/*
				FUNCTIONS
			*/

			function salvarNome(){
				let nome = document.getElementById('nome').value;
				player.name = nome;
				document.getElementById("canvas").style.display = 'block'
				document.getElementById("form").style.display = 'none'
			}


			function draw(){
				ctx.fillStyle = "white"
				ctx.fillRect(0, 0, WIDTH, HEIGHT)
				ctx.fillStyle = 'blue'
				ctx.fillRect(player.x, player.y, player.w, player.h);
				ctx.font = "20px Georgia";
				ctx.fillStyle = "black"
				ctx.fillText(player.name, 20, 40);
				if(enemy){
					ctx.fillStyle = "black"
					ctx.fillText(enemy.name, WIDTH - 80, 40);
					ctx.fillStyle = 'red'
					ctx.fillRect(enemy.x, enemy.y, enemy.w, enemy.h);
				}
				if(bulletPlayer.shooting){
					ctx.fillStyle = 'black'
					ctx.fillRect(bulletPlayer.x, bulletPlayer.y, bulletPlayer.w, bulletPlayer.h);
				}
			}

			function update(){
				player.y += player.gravity
				if(player.y + player.h >= HEIGHT){
					player.gravity = 0;
				}
				if(player.y + player.h < HEIGHT && !keyUp){
					player.gravity = 5;
				}
				if(player.y + player.h > HEIGHT){
					player.y = HEIGHT - player.h
				}
				if(keyRight) {
					if(player.x + player.w <= WIDTH){
						player.x += player.speed
					}else{
						keyRight = false;
					}
				}
				if(keyLeft){
					if(player.x >= 0){
						player.x -= player.speed
					}else{
						keyLeft = false;
					}
				}
				if(keyUp){
					console.log('JUMP')
					player.gravity = -15;
					/*if(player.y >= 0){
						player.y -= player.speed
					}else{
						keyUp = false;
					}*/
				}
				if(keyDown){
					console.log('Abaixar')
					if(player.y + player.h <= HEIGHT){
						player.h = 16;
						player.y = player.y + (player.h / 2)
					}
					/*
					if(player.y + player.h <= HEIGHT){
						player.y += player.speed
					}else{
						keyDown = false;
					}
					*/
				}
				if(shootLeft){
					bulletPlayer.shooting = true;
					bulletPlayer.x = player.x + (player.w / 2)
					bulletPlayer.y = player.y + (player.h / 2)
					bulletPlayer.speed = -8;
				}
				if(shootRight){
					bulletPlayer.shooting = true;
					bulletPlayer.x = player.x + (player.w / 2)
					bulletPlayer.y = player.y + (player.h / 2)
					bulletPlayer.speed = 8;
				}
				if(bulletPlayer.shooting){
					bulletPlayer.x += bulletPlayer.speed
				}
				if(bulletPlayer.x + bulletPlayer.w > enemy.x && 
					bulletPlayer.x < enemy.x + enemy.w &&
					bulletPlayer.y + bulletPlayer.h > enemy.y &&
					bulletPlayer.y < enemy.y + enemy.h
				){
					console.log('acertou')
					bulletPlayer.shooting = false;
				}
				if(bulletPlayer.x > WIDTH || bulletPlayer.x < 0){
					bulletPlayer.shooting = false;
				}
			}

			function createbulletPlayer(direction){
				bulletPlayer.speed = direction
			}

			/*
			function getMousePos(evt) {
				var rect = canvas.getBoundingClientRect();		
				player.x = evt.clientX - rect.left,
				player.y = evt.clientY - rect.top
				ctx.fillRect(player.x, player.y - 12, 24, 24);
				socket.emit('sendPosition', player);
			}*/

			/*
				KEYBOAR HANDLER
			*/
			function keyDownHandler(event) {
				if(event.keyCode == KEYS.right) {
					keyRight = true;
				}
				if(event.keyCode == KEYS.left){
					if(player.x > 0){
						keyLeft = true;
					}					
				}
				if(event.keyCode == KEYS.up){
					if(player.y > 0){
						keyUp = true;
					}					
				}
				if(event.keyCode == KEYS.down){
					keyDown = true;
				}
				if(!bulletPlayer.shooting){
					if(event.keyCode === KEYS.shootLeft){
						shootLeft = true;
					}
					if(event.keyCode === KEYS.shootRight){
						shootRight = true;
					}
				}
			}

			function keyUpHandler(event) {
				if(event.keyCode == KEYS.right) {
					keyRight = false;
				}
				if(event.keyCode == KEYS.left){
					keyLeft = false;
				}
				if(event.keyCode == KEYS.up){
					keyUp = false;
				}
				if(event.keyCode == KEYS.down){
					player.y = player.y - (player.h / 2)
					player.h = 32;
					keyDown = false;
				}
				if(event.keyCode == KEYS.shootLeft){
					shootLeft = false;
				}
				if(event.keyCode == KEYS.shootRight){
					shootRight = false;
				}
			}

			socket.on('position', data => {
				//console.log(data)
				enemy = data
			})

			setInterval(function() {
				socket.emit('sendPosition', player);
				update()
				draw()
			}, 1000/60)
		</script>
	</body>
</html>