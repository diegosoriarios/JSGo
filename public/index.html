<!DOCTYPE html>
	<html>
	<head>
		<title>Chat</title>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/socket.io/2.2.0/socket.io.js"></script>
		<script type="text/javascript" src="https://cdnjs.cloudflare.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
		<link rel="shortcut icon" href="#">
		<style>
			canvas {
				background-color: grey;
				border: 1px solid black;
			}
		</style>
	</head>
	<body>
		<div id="form">
			<label>Nome: </label>
			<input name="nome" id="nome" />
			<button id="submit" onclick="salvarNome()">Salvar</button>
		</div>
		<canvas id="canvas" height="600" width="800" style="display: none"></canvas>
		<script type="text/javascript">
			var socket = io('http://localhost:3000')

			const canvas = document.getElementById('canvas')
			const ctx = canvas.getContext('2d')
			//canvas.addEventListener('click', getMousePos, false);
			document.addEventListener('keydown', keyDownHandler, false);
			document.addEventListener('keyup', keyUpHandler, false);

			/*
				VARIABLES
			*/

			const HEIGHT = 600
			const WIDTH = 800

			const KEYS ={
				up: 87,
				down: 83,
				right: 68,
				left: 65
			}

			let keyUp = false;
			let keyDown = false;
			let keyRight = false;
			let keyLeft = false;

			let player = {
				name: '',
				x: Math.floor(Math.random() * WIDTH),
				y: Math.floor(Math.random() * HEIGHT),
				speed: 2,
				w: 32,
				h: 32,
			}

			let enemy = {
				name: '',
				x: Math.floor(Math.random() * WIDTH),
				y: Math.floor(Math.random() * HEIGHT),
				speed: 2,
				w: 32,
				h: 32,
			}

			/*
				FUNCTIONS
			*/

			function salvarNome(){
				let nome = document.getElementById('nome').value;
				player.name = nome;
				document.getElementById("canvas").style.display = 'block'
				document.getElementById("form").style.display = 'none'
			}


			function draw(){
				ctx.fillStyle = "white"
				ctx.fillRect(0, 0, WIDTH, HEIGHT)
				ctx.fillStyle = 'blue'
				ctx.fillRect(player.x, player.y, player.w, player.h);
				ctx.font = "20px Georgia";
				ctx.fillStyle = "black"
				ctx.fillText(player.name, 20, 40);
				if(enemy){
					ctx.fillStyle = "black"
					ctx.fillText(enemy.name, WIDTH - 80, 40);
					ctx.fillStyle = 'red'
					ctx.fillRect(enemy.x, enemy.y, enemy.w, enemy.h);
				}
			}

			function update(){
				if(keyRight) {
					player.x += player.speed
				}
				if(keyLeft){
					player.x -= player.speed
				}
				if(keyUp){
					player.y -= player.speed
				}
				if(keyDown){
					player.y += player.speed
				}
			}

			/*
			function getMousePos(evt) {
				var rect = canvas.getBoundingClientRect();		
				player.x = evt.clientX - rect.left,
				player.y = evt.clientY - rect.top
				ctx.fillRect(player.x, player.y - 12, 24, 24);
				socket.emit('sendPosition', player);
			}*/

			/*
				KEYBOAR HANDLER
			*/
			function keyDownHandler(event) {
				if(event.keyCode == KEYS.right) {
					keyRight = true;
				}
				if(event.keyCode == KEYS.left){
					keyLeft = true;
				}
				if(event.keyCode == KEYS.up){
					keyUp = true;
				}
				if(event.keyCode == KEYS.down){
					keyDown = true;
				}
			}

			function keyUpHandler(event) {
				if(event.keyCode == KEYS.right) {
					keyRight = false;
				}
				if(event.keyCode == KEYS.left){
					keyLeft = false;
				}
				if(event.keyCode == KEYS.up){
					keyUp = false;
				}
				if(event.keyCode == KEYS.down){
					keyDown = false;
				}
			}

			socket.on('position', data => {
				console.log(data)
				enemy = data
			})

			setInterval(function() {
				socket.emit('sendPosition', player);
				update()
				draw()
			}, 1000/60)
		</script>
	</body>
</html>